<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - WallpaperHub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="shortcut icon" href="/static/Colorful Minimalist Space Desktop Wallpaper 2.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Message Container -->
    <div id="message-container" class="message-container"></div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <div class="analytics-container">
        <header class="analytics-header">
            <div class="header-content">
                <div class="header-text">
                    <h1>üìä Analytics Dashboard</h1>
                    <p>Real-time insights and download statistics</p>
                </div>
                <div class="header-actions">
                    <button class="refresh-btn" onclick="refreshAnalytics()">
                        <span class="refresh-icon">üîÑ</span>
                        Refresh Data
                    </button>
                    <a href="/" class="back-btn">
                        <span class="back-icon">üè†</span>
                        Back to Home
                    </a>
                </div>
            </div>
        </header>

        <main class="analytics-main">
            <!-- Device Toggle (copied from index.html) -->
            <div class="device-toggle-container">
                <div class="device-toggle">
                    <button class="device-btn active" data-device="mobile" onclick="switchDeviceType('mobile')">
                        üì± Mobile
                    </button>
                    <button class="device-btn" data-device="pc" onclick="switchDeviceType('pc')">
                        üíª PC
                    </button>
                </div>
                <div class="device-info">
                    <span id="device-count">-</span> wallpapers available
                </div>
            </div>
            <!-- Overview Stats -->
            <section class="analytics-overview">
                <h2 class="section-title">üìà Overview</h2>
                <div class="analytics-stats-grid">
                    <div class="analytics-stat-card primary">
                        <div class="stat-icon">üì•</div>
                        <div class="stat-info">
                            <div class="stat-number" id="analytics-total-downloads">-</div>
                            <div class="stat-label">Total Downloads</div>
                            <div class="stat-change">+12% this week</div>
                        </div>
                    </div>
                    <div class="analytics-stat-card secondary">
                        <div class="stat-icon">üé®</div>
                        <div class="stat-info">
                            <div class="stat-number" id="analytics-total-wallpapers">-</div>
                            <div class="stat-label">Total Wallpapers</div>
                            <div class="stat-change">+3 new today</div>
                        </div>
                    </div>
                    <div class="analytics-stat-card accent">
                        <div class="stat-icon">üî•</div>
                        <div class="stat-info">
                            <div class="stat-number" id="analytics-downloads-24h">-</div>
                            <div class="stat-label">Downloads (24h)</div>
                            <div class="stat-change">+8% vs yesterday</div>
                        </div>
                    </div>
                    <div class="analytics-stat-card success">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-info">
                            <div class="stat-number" id="analytics-avg-downloads">-</div>
                            <div class="stat-label">Avg per Wallpaper</div>
                            <div class="stat-change">Trending up</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Charts Section -->
            <section class="analytics-charts">
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>üìä Category Popularity</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" onclick="exportChart('category')">Export</button>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>üìà Download Trends</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" onclick="exportChart('trends')">Export</button>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="trendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Top Wallpapers Table -->
            <section class="analytics-table-section">
                <div class="table-header">
                    <h3>üèÜ Top Performing Wallpapers</h3>
                    <div class="table-actions">
                        <button class="table-btn" onclick="exportTable()">Export CSV</button>
                        <select class="table-filter" onchange="filterTable(this.value)">
                            <option value="all">All Time</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table class="analytics-table-content">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Wallpaper</th>
                                <th>Category</th>
                                <th>Downloads</th>
                                <th>Upload Date</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody id="top-wallpapers-table">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="analytics-recent">
                <div class="recent-header">
                    <h3>üïí Recent Activity</h3>
                    <div class="activity-filter">
                        <button class="activity-btn active" onclick="filterActivity('all')">All</button>
                        <button class="activity-btn" onclick="filterActivity('downloads')">Downloads</button>
                        <button class="activity-btn" onclick="filterActivity('uploads')">Uploads</button>
                    </div>
                </div>
                <div class="recent-downloads" id="recent-downloads">
                    <!-- Populated by JavaScript -->
                </div>
            </section>
        </main>
    </div>

    <script>
    // Analytics JavaScript
    let categoryChart, trendsChart;
    let CURRENT_DEVICE_TYPE = 'mobile';

        // Message system functions
        function showMessage(message, type = "info", duration = 3000) {
            const messageContainer = document.getElementById("message-container")
            const messageEl = document.createElement("div")
            messageEl.className = `custom-message ${type}`
            messageEl.innerHTML = `
                <div class="message-content">
                    <span class="message-text">${message}</span>
                    <button class="message-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `

            messageContainer.appendChild(messageEl)

            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.remove()
                }
            }, duration)
        }

        function showToast(message, type = "info", duration = 3000) {
            const toastContainer = document.getElementById("toast-container")
            const toast = document.createElement("div")
            toast.className = `toast ${type}`
            toast.textContent = message

            toastContainer.appendChild(toast)

            setTimeout(() => toast.classList.add("show"), 100)

            setTimeout(() => {
                toast.classList.remove("show")
                setTimeout(() => toast.remove(), 300)
            }, duration)
        }

        // Load analytics data
        async function loadAnalyticsData(deviceType = 'mobile') {
            try {
                showToast("Loading analytics data... üìä", "info", 2000)
                const [statsResponse, wallpapersResponse] = await Promise.all([
                    fetch(`/api/stats?device=${deviceType}`),
                    fetch(`/api/wallpapers?device=${deviceType}`)
                ]);
                const stats = await statsResponse.json();
                const wallpapers = await wallpapersResponse.json();
                document.getElementById('device-count').textContent = wallpapers.length;
                updateOverviewStats(stats, wallpapers);
                updateCategoryChart(stats.popular_categories);
                updateTopWallpapersTable(wallpapers);
                showMessage("Analytics data loaded successfully! ‚úÖ", "success", 2000)
            } catch (error) {
                console.error('Error loading analytics data:', error);
                showMessage("Failed to load analytics data üòû", "error", 3000)
            }
        }

        function switchDeviceType(device) {
            CURRENT_DEVICE_TYPE = device;
            document.querySelectorAll('.device-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-device') === device);
            });
            loadAnalyticsData(device);
        }

        // Update overview statistics
        function updateOverviewStats(stats, wallpapers) {
            document.getElementById('analytics-total-downloads').textContent = stats.total_downloads.toLocaleString();
            document.getElementById('analytics-total-wallpapers').textContent = stats.total_wallpapers.toLocaleString();
            document.getElementById('analytics-downloads-24h').textContent = stats.downloads_24h.toLocaleString();
            
            const avgDownloads = stats.total_wallpapers > 0 ? Math.round(stats.total_downloads / stats.total_wallpapers) : 0;
            document.getElementById('analytics-avg-downloads').textContent = avgDownloads.toLocaleString();
        }

        // Update category chart
        function updateCategoryChart(categories) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }

            const labels = Object.keys(categories);
            const data = Object.values(categories);
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#ffa500', '#9b59b6', '#2ecc71'];

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(label => label.charAt(0).toUpperCase() + label.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#1a1a1a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // Update top wallpapers table
        function updateTopWallpapersTable(wallpapers) {
            const tableBody = document.getElementById('top-wallpapers-table');
            const sortedWallpapers = wallpapers.sort((a, b) => (b.download_count || 0) - (a.download_count || 0));
            
            tableBody.innerHTML = sortedWallpapers.slice(0, 10).map((wallpaper, index) => `
                <tr>
                    <td><span class="rank rank-${index < 3 ? 'top' : 'normal'}">#${index + 1}</span></td>
                    <td>
                        <div class="wallpaper-info">
                            <img src="/static/wallpapers/${wallpaper.filename}" alt="${wallpaper.title}" class="table-thumbnail">
                            <span class="wallpaper-title">${wallpaper.title}</span>
                        </div>
                    </td>
                    <td><span class="category-badge category-${wallpaper.category}">${wallpaper.category}</span></td>
                    <td><strong class="download-number">${(wallpaper.download_count || 0).toLocaleString()}</strong></td>
                    <td class="upload-date">${new Date(wallpaper.upload_date).toLocaleDateString()}</td>
                    <td>
                        <div class="performance-indicator ${getPerformanceClass(wallpaper.download_count || 0)}">
                            ${getPerformanceText(wallpaper.download_count || 0)}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getPerformanceClass(downloads) {
            if (downloads > 40) return 'excellent';
            if (downloads > 25) return 'good';
            if (downloads > 10) return 'average';
            return 'low';
        }

        function getPerformanceText(downloads) {
            if (downloads > 40) return 'üî• Excellent';
            if (downloads > 25) return 'üëç Good';
            if (downloads > 10) return 'üìà Average';
            return 'üìä Low';
        }

        // Utility functions
        function refreshAnalytics() {
            showToast("Refreshing analytics... üîÑ", "info", 1500)
            loadAnalyticsData()
        }

        function exportChart(type) {
            showMessage(`Exporting ${type} chart... üìä`, "info", 2000)
        }

        function exportTable() {
            showMessage("Exporting table data... üìã", "info", 2000)
        }

        function filterTable(period) {
            showToast(`Filtering by ${period}... üîç`, "info", 1500)
        }

        async function filterActivity(type) {
            document.querySelectorAll('.activity-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            showToast(`Showing ${type} activity... üìã`, "info", 1500);
            await loadRecentActivity(type, CURRENT_DEVICE_TYPE);
        }

        async function loadRecentActivity(activityType = 'all', deviceType = 'mobile') {
            const recentDownloadsDiv = document.getElementById('recent-downloads');
            recentDownloadsDiv.innerHTML = '<div class="spinner"></div><p>Loading activity...</p>';
            try {
                const response = await fetch(`/api/activity?type=${activityType}&device=${deviceType}`);
                const data = await response.json();
                if (!data.length) {
                    recentDownloadsDiv.innerHTML = '<div class="no-wallpapers"><div class="no-wallpapers-icon">üì≠</div><p>No recent activity found</p></div>';
                    return;
                }
                recentDownloadsDiv.innerHTML = data.map(item => `
                    <div class="activity-item">
                        <div class="activity-icon">${item.type === 'download' ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è'}</div>
                        <div class="activity-info">
                            <span class="activity-title">${item.title}</span>
                            <span class="activity-meta">${item.type === 'download' ? 'Downloaded' : 'Uploaded'} on ${new Date(item.date).toLocaleString()}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                recentDownloadsDiv.innerHTML = '<div class="no-wallpapers"><div class="no-wallpapers-icon">üòû</div><p>Failed to load activity</p></div>';
            }
        }

        // Initialize analytics
        document.addEventListener('DOMContentLoaded', () => {
            loadAnalyticsData(CURRENT_DEVICE_TYPE);
            loadRecentActivity('all', CURRENT_DEVICE_TYPE);
            // Refresh data every 30 seconds
            setInterval(() => loadAnalyticsData(CURRENT_DEVICE_TYPE), 30000);
        });
    </script>
</body>
</html>
